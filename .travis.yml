os: linux
dist: bionic

branches:
  only:
  - master
  - /travis/

language: java

# precise
#   Oracle JDK 7 (oraclejdk7)
#   OpenJDK 7 (openjdk7)
#   OpenJDK 6 (openjdk6)
#   Oracle JDK 8 (oraclejdk8)

# trusty
#   Open JDK 7 (openjdk7)
#   Open JDK 8 (openjdk8)
#   Oracle JDK 8 (oraclejdk8). Default.
#   Oracle JDK 9 (oraclejdk9)
#   Oracle JDK 7 is not provided because it reached End of Life in April 2015.
#   Oracle JDK 10 is not provided because it reached End of Life in October 2018.
#   Oracle JDK 11 (oraclejdk11)

# xenial
#   openjdk8, openjdk10, and openjdk11

# bionic
#   openjdk8, openjdk10, and openjdk11

jdk:
#  current LTS versions
#  - openjdk14 - build is failing #163
#  - oraclejdk14 - build is failing #163
  - openjdk11
  - oraclejdk11
  - openjdk8
#  - oraclejdk8 - missing from current TravisCI workers

# cache local Maven repo: https://docs.travis-ci.com/user/caching/
cache:
  directories:
  - $HOME/.m2/repository
  # $HOME/.m2/wrapper may include maven-wrapper.jar, because we copy it there in 'before_cache'.
  # We can't cache $TRAVIS_BUILD_DIR/.mvn/wrapper/maven-wrapper.jar directly
  # without potentially overwriting part of the source tree (eg if the jar is
  # added to git in future)
  - $HOME/.m2/wrapper
before_cache:
  - cp -a $TRAVIS_BUILD_DIR/.mvn/wrapper/maven-wrapper.jar $HOME/.m2/wrapper/
  - rm -rf $HOME/.m2/repository/org/jglue/cdi-unit/

env:
  # We don't want to overtax travis (or get throttled), so we try to limit the number of combinations.
  # Current strategy is, for each supported minor version of Weld, to test one early point release plus
  # the most recent point release, plus some point releases which caused problems.
  # There is one version source per minor release of Weld, newer releases on top.
  - VERSION_SOURCE=weld-v3.1.sh
  - VERSION_SOURCE=weld-v3.0.sh
  - VERSION_SOURCE=weld-v2.4.sh
  - VERSION_SOURCE=weld-v2.3.sh
  - VERSION_SOURCE=weld-v2.2.sh
  - VERSION_SOURCE=weld-v2.1.sh
  - VERSION_SOURCE=weld-v2.0.sh
  - VERSION_SOURCE=weld-v1.1.sh

# Installing the dependencies here saves many log lines (Travis limit is 10000)
install:
- |
  cp ./travisci/settings.xml $HOME/.m2/settings.xml
  travis_wait ./mvnw -V clean verify -Dmaven.main.skip -Dmaven.test.skip --quiet --batch-mode

script:
- |
  set -e
  # copy wrapper jar from cache, if it exists, but don't overwrite one in the source tree, if it exists:
  false | cp -ai $HOME/.m2/wrapper/maven-wrapper.jar $TRAVIS_BUILD_DIR/.mvn/wrapper/ 2>/dev/null || true
  ./travisci/build.sh ${VERSION_SOURCE}
